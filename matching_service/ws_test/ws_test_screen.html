<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Matchmaking</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        input, select, button { margin: 5px; }
        ul { list-style-type: none; padding-left: 0; }
        li { padding: 2px 0; }
    </style>
</head>
<body>
    <h1>WebSocket Matchmaking Test</h1>

    <!-- User ID -->
    <label for="userIdInput">User ID:</label>
    <input type="text" id="userIdInput" placeholder="Enter user ID" autocomplete="off"/>
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn">Disconnect</button>
    <br><br>

    <!-- Criteria Selection -->
    <label for="topicSelect">Topics:</label>
    <select id="topicSelect" multiple></select>

    <label for="difficultySelect">Difficulty:</label>
    <select id="difficultySelect" multiple></select>
    <br><br>

    <!-- Language Selection -->
    <label for="primaryLangSelect">Primary Language:</label>
    <select id="primaryLangSelect">
        <option value="">-- Select --</option>
        <option value="Python">Python</option>
        <option value="Java">Java</option>
        <option value="Javascript">JavaScript</option>
    </select>

    <label for="secondaryLangSelect">Secondary Languages:</label>
    <select id="secondaryLangSelect" multiple>
        <option value="Python">Python</option>
        <option value="Java">Java</option>
        <option value="Javascript">JavaScript</option>
    </select>

    <ul id="messages"></ul>

    <script>
        let ws;

        // -----------------------------
        // Helper functions
        // -----------------------------
        function printMessage(msg) {
            const messages = document.getElementById('messages');
            const message = document.createElement('li');
            message.textContent = msg;
            messages.appendChild(message);
        }

        function getSelectedValues(selectId) {
            const select = document.getElementById(selectId);
            return Array.from(select.selectedOptions).map(opt => opt.value);
        }

        // -----------------------------
        // Dynamic loading of topics and difficulties
        // -----------------------------
        async function loadSelectOptions() {
            try {
                // Fetch topics from backend
                const topicsRes = await fetch('http://127.0.0.1:8001/api/topics');

                if (!topicsRes.ok) {
                    throw new Error(`Failed to fetch topics: HTTP ${topicsRes.status}`);
                }

                const data = await topicsRes.json();
                const topics = data.topics || [];

                // Use hardcoded difficulties for now
                const difficulties = ["easy", "medium", "hard"];

                // Get select elements
                const topicSelect = document.getElementById('topicSelect');
                const difficultySelect = document.getElementById('difficultySelect');

                // Clear existing options
                topicSelect.innerHTML = '';
                difficultySelect.innerHTML = '';

                // Populate topics
                topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.value || topic; // supports object {value,label} or string
                    option.textContent = topic.label || topic;
                    topicSelect.appendChild(option);
                });

                // Populate difficulties
                difficulties.forEach(diff => {
                    const option = document.createElement('option');
                    option.value = diff.value || diff; // supports object {value,label} or string
                    option.textContent = diff.label || diff;
                    difficultySelect.appendChild(option);
                });

                printMessage('Loaded topics and difficulties successfully.');
            } catch (error) {
                printMessage('Error loading topics/difficulties: ' + error.message);
            }
        }


        // Load options on page load
        window.onload = loadSelectOptions;

        // -----------------------------
        // WebSocket connection handlers
        // -----------------------------
        document.getElementById("connectBtn").onclick = function() {
            const userId = document.getElementById("userIdInput").value.trim();
            const topics = getSelectedValues("topicSelect");
            const difficulties = getSelectedValues("difficultySelect");
            const primaryLang = document.getElementById("primaryLangSelect").value;
            const secondaryLangs = getSelectedValues("secondaryLangSelect");

            // Validation
            if (!userId) { alert("Please enter a user ID."); return; }
            if (topics.length === 0) { alert("Please select at least one topic."); return; }
            if (!primaryLang) { alert("Please select a primary language."); return; }
            if (secondaryLangs.length === 0) { alert("Please select at least one secondary language."); return; }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                ws = new WebSocket(`ws://localhost:8002/api/ws?user_id=${userId}`);

                ws.onopen = function() {
                    printMessage(`Connected as user ${userId}`);

                    fetch("http://127.0.0.1:8002/api/match", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            user_id: userId,
                            criteria: {
                                topics: topics,
                                difficulty: difficulties,
                                primary_lang: primaryLang,
                                secondary_lang: secondaryLangs
                            }
                        })
                    })
                    .then(res => res.json())
                    .then(data => printMessage(`Match API response: ${JSON.stringify(data)}`))
                    .catch(err => printMessage(`Error calling /api/match: ${err}`));

                    printMessage(`Criteria sent: 
                        topics: [${topics.join(", ")}], 
                        difficulty: [${difficulties.join(", ")}], 
                        primary_lang: ${primaryLang}, 
                        secondary_lang: [${secondaryLangs.join(", ")}]`);
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data); // parse JSON first

                        // Start with status
                        let formatted = `Status: ${data.status ?? "N/A"}`;

                        if (data.status?.toLowerCase() === "success" && data.session) {
                            const session = data.session;

                            formatted += `<br>
                            Session ID: ${session.session_id ?? "N/A"}<br>
                            User IDs: ${Array.isArray(session.user_id_list) ? session.user_id_list.join(", ") : "N/A"}<br>
                            Question ID: ${session.question_id ?? "N/A"}<br>
                            Title: ${session.title ?? "N/A"}<br>
                            Statement: ${session.statement_md ?? "N/A"}<br>
                            Assets: ${Array.isArray(session.assets) ? session.assets.join(", ") : "N/A"}<br>
                            Topics: ${Array.isArray(session.topics) ? session.topics.join(", ") : "N/A"}<br>
                            Difficulty: ${session.difficulty ?? "N/A"}<br>
                            Language: ${session.language ?? "N/A"}<br>
                            Company Tags: ${Array.isArray(session.company_tags) ? session.company_tags.join(", ") : "N/A"}<br>
                            Examples: ${Array.isArray(session.examples) ? session.examples.join("<br>") : "N/A"}<br>
                            Constraints: ${Array.isArray(session.constraints) ? session.constraints.join("<br>") : "N/A"}<br>
                            Timestamp: ${session.timestamp ? new Date(session.timestamp).toLocaleString() : "N/A"}`;
                        }

                        // Inject into <ul> as HTML
                        const messages = document.getElementById('messages');
                        const li = document.createElement('li');
                        li.innerHTML = formatted;
                        messages.appendChild(li);

                    } catch (err) {
                        console.warn("Non-JSON WebSocket message:", event.data);
                        printMessage("Non-JSON message: " + event.data);
                    }
                };





                ws.onclose = function() {
                    printMessage("WebSocket connection closed.");
                };

                ws.onerror = function(err) {
                    printMessage("WebSocket error: " + JSON.stringify(err));
                };
            }
        };

        document.getElementById("disconnectBtn").onclick = function() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const userId = document.getElementById("userIdInput").value.trim();
                fetch(`http://127.0.0.1:8002/api/match?user_id=${userId}`, {
                        method: "DELETE",
                        headers: { "Content-Type": "application/json" }
                    });
                printMessage("Disconnected manually.");
            }
        };
    </script>
</body>
</html>
